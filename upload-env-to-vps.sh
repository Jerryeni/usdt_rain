#!/bin/bash

# Upload .env file to VPS
# This will upload your backend .env file to the VPS

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                              â•‘"
echo "â•‘   ğŸ“¤ Upload .env File to VPS                                 â•‘"
echo "â•‘                                                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if local .env exists
if [ ! -f backend/.env ]; then
  echo "âŒ ERROR: backend/.env file not found locally!"
  echo ""
  echo "Please create backend/.env file first with your production settings."
  echo "You can copy from backend/.env.production.example"
  exit 1
fi

echo "ğŸ“‹ Current .env file content (local):"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
cat backend/.env
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "âš ï¸  IMPORTANT: This will upload your .env file to:"
echo "   /var/www/usdtrain-backend/backend/.env"
echo ""
echo "âš ï¸  WARNING: This file contains sensitive information!"
echo "   - Private keys"
echo "   - API credentials"
echo ""

read -p "Do you want to upload this .env file? (type 'yes' to continue): " -r
echo

if [[ ! $REPLY == "yes" ]]; then
    echo "âŒ Aborted by user."
    exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¤ Uploading .env file to VPS..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Upload .env file
scp backend/.env root@147.93.110.96:/var/www/usdtrain-backend/backend/.env

if [ $? -eq 0 ]; then
  echo "âœ… .env file uploaded successfully!"
else
  echo "âŒ Failed to upload .env file"
  exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”’ Setting secure permissions..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

ssh root@147.93.110.96 << 'ENDSSH'

cd /var/www/usdtrain-backend/backend

# Set secure permissions (only owner can read/write)
chmod 600 .env

echo "âœ… Permissions set to 600 (owner read/write only)"

echo ""
echo "Verifying .env file on VPS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
ls -la .env
echo ""
echo "Environment variables (keys only, no values):"
grep -v '^#' .env | grep '=' | cut -d'=' -f1

ENDSSH

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                              â•‘"
echo "â•‘   âœ… .env FILE UPLOADED SUCCESSFULLY!                        â•‘"
echo "â•‘                                                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“‹ Next Steps:"
echo ""
echo "1. Restart the backend:"
echo "   ssh root@147.93.110.96 'cd /var/www/usdtrain-backend/backend && pm2 restart usdtrain-backend'"
echo ""
echo "2. Or run the nuclear fix again:"
echo "   ./nuclear-fix.sh"
echo ""
echo "3. Check logs:"
echo "   ssh root@147.93.110.96 'pm2 logs usdtrain-backend'"
echo ""
